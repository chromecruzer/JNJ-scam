const express=require("express"),path=require("path"),multer=require("multer"),nodemailer=require("nodemailer"),dotenv=require("dotenv"),fs=require("fs");dotenv.config();const app=express(),port=process.env.PORT||3e3,storage=multer.memoryStorage(),upload=multer({storage:storage}),transporter=nodemailer.createTransport({service:"Gmail",auth:{user:process.env.GMAIL_USER,pass:process.env.GMAIL_PASS}});app.use(express.json()),app.use(express.urlencoded({extended:!0})),app.use(express.static(path.join(__dirname,"public"))),app.set("view engine","pug"),app.set("views","./views"),app.get("/",((e,n)=>{n.render("index")})),app.post("/submit",upload.fields([{name:"proof",maxCount:1},{name:"screenshots",maxCount:5}]),(async(e,n)=>{const{name:s,gender:o,email:r,complaint:t}=e.body,a=e.files.proof[0],i=e.files.screenshots||[];if(!(s&&o&&r&&t&&a))return console.log("Required fields are missing:",e.body),n.status(400).send("Please provide name, gender, email, complaint, and proof");console.log("Form data received:",e.body);const l={from:process.env.GMAIL_USER,to:process.env.GMAIL_RECIPIENT,subject:`Form submission regarding JNJ company complaint from ${s}`,text:`\n      Name: ${s}\n      Gender: ${o}\n      Email: ${r}\n      Complaint: ${t}\n    `,attachments:[{filename:a.originalname,content:a.buffer},...i.map((e=>({filename:e.originalname,content:e.buffer})))]};try{await transporter.sendMail(l),console.log("Message sent successfully"),n.send('\n      <!doctype html>\n      <html>\n        <head>\n          <title>Form Submission</title> \n          <style>\n            body {\n              font-family: Arial, sans-serif;\n              background-color: #f2f2f2;\n              display: flex;\n              justify-content: center;\n              align-items: center;\n              height: 100vh;\n              margin: 0;\n            }\n            .container {\n              background-color: #fff;\n              padding: 20px;\n              border-radius: 8px;\n              box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);\n              text-align: center;\n            }\n            h1 {\n              color: #333;\n            }\n            a {\n              display: inline-block;\n              margin-top: 20px;\n              text-decoration: none;\n              color: #4CAF50;\n              font-weight: bold;\n            }\n          </style>\n        </head>\n        <body>\n          <div class="container">\n            <h1>Message sent successfully</h1>\n            <a href="/">Go back to the form</a>\n          </div>\n        </body>\n      </html>\n    ')}catch(e){console.error("Failed to send message:",e),n.status(500).send("Failed to send message")}})),app.listen(port,(()=>{console.log(`Server is running at http://localhost:${port}`)}));