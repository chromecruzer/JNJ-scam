const express=require("express"),path=require("path"),multer=require("multer"),nodemailer=require("nodemailer"),dotenv=require("dotenv"),fs=require("fs");dotenv.config();const app=express(),port=process.env.PORT||3e3,storage=multer.memoryStorage(),upload=multer({storage:storage}),transporter=nodemailer.createTransport({service:"Gmail",auth:{user:process.env.GMAIL_USER,pass:process.env.GMAIL_PASS}});app.use(express.json()),app.use(express.urlencoded({extended:!0})),app.use(express.static(path.join(__dirname,"public"))),app.set("view engine","pug"),app.set("views","./views"),app.get("/",((e,s)=>{s.render("index")})),app.post("/submit",upload.fields([{name:"proof",maxCount:1},{name:"screenshots",maxCount:5}]),(async(e,s)=>{const{name:r,gender:n,email:o,complaint:a}=e.body,t=e.files.proof[0],i=e.files.screenshots||[];if(!(r&&n&&o&&a&&t))return console.log("Required fields are missing:",e.body),s.status(400).send("Please provide name, gender, email, complaint, and proof");console.log("Form data received:",e.body);const p={from:process.env.GMAIL_USER,to:process.env.GMAIL_RECIPIENT,subject:`Form submission regarding JNJ company complaint from ${r}`,text:`\n      Name: ${r}\n      Gender: ${n}\n      Email: ${o}\n      Complaint: ${a}\n    `,attachments:[{filename:t.originalname,content:t.buffer},...i.map((e=>({filename:e.originalname,content:e.buffer})))]};try{await transporter.sendMail(p),console.log("Message sent successfully"),s.send("Message sent successfully")}catch(e){console.error("Failed to send message:",e),s.status(500).send("Failed to send message")}})),app.listen(port,(()=>{console.log(`Server is running at http://localhost:${port}`)}));